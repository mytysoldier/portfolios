"""
è¨­è¨ˆãƒ»ä»•æ§˜å¤‰æ›ãƒ•ã‚§ãƒ¼ã‚º - Claude CodeãŒä¸»æ‹…å½“
"""
from typing import Dict, Any
from .base_phase import SyncPhase
from .context import ProjectContext


class DesignPhase(SyncPhase):
    """
    ãƒ•ã‚§ãƒ¼ã‚ºâ‘¡ è¨­è¨ˆãƒ»ä»•æ§˜å¤‰æ›
    ä¸»æ‹…å½“: Claude Code, è£œåŠ©: Gemini
    """
    
    def __init__(self):
        super().__init__("design")
    
    def execute_sync(self, context: ProjectContext) -> Dict[str, Any]:
        """è¨­è¨ˆãƒ»ä»•æ§˜å¤‰æ›ã‚’å®Ÿè¡Œ"""
        
        self._log(context, "è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹...")
        
        # å‰ãƒ•ã‚§ãƒ¼ã‚ºã®çµæœã‚’å–å¾—
        requirement_result = context.get_phase_result("requirement")
        if not requirement_result or not requirement_result.get("analysis_completed"):
            self._error(context, "è¦ä»¶åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return {"design_completed": False, "error": "è¦ä»¶åˆ†ææœªå®Œäº†"}
        
        try:
            # Claude Code (è‡ªåˆ†è‡ªèº«) ã¨ã—ã¦è¨­è¨ˆã‚’å®Ÿè¡Œ
            design_result = self._create_technical_design(
                context.user_request, 
                requirement_result["raw_response"]
            )
            
            design_output = {
                "technical_specification": design_result,
                "design_completed": True,
                "based_on_requirement": True
            }
            
            # çµæœã‚’ä¿å­˜
            self.save_result(context, design_output)
            
            return design_output
            
        except Exception as e:
            self._error(context, f"è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºå¤±æ•—: {str(e)}")
            return {
                "technical_specification": "",
                "design_completed": False,
                "error": str(e)
            }
    
    def _create_technical_design(self, user_request: str, requirement_analysis: str) -> str:
        """æŠ€è¡“ä»•æ§˜æ›¸ã‚’ä½œæˆï¼ˆè¨€èªéä¾å­˜ï¼‰"""
        
        design_doc = f"""
# æŠ€è¡“è¨­è¨ˆä»•æ§˜æ›¸

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: {user_request}

## 2. è¦ä»¶åˆ†æçµæœã®æ•´ç†
{requirement_analysis}

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 3.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æ±ºå®š
- **æ¨å¥¨è¨€èª**: è¦ä»¶ã‹ã‚‰æœ€é©ãªè¨€èªã‚’é¸æŠ
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: å¿…è¦ã«å¿œã˜ã¦é©åˆ‡ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: æ©Ÿèƒ½å®Ÿç¾ã«å¿…è¦ãªå¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- **å®Ÿè¡Œç’°å¢ƒ**: å¯¾è±¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ»ç’°å¢ƒ

### 3.2 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
- **ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ**: ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
- **ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: ä¸»è¦æ©Ÿèƒ½ã‚’æ‹…å½“ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£**: å…±é€šæ©Ÿèƒ½ãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
- **è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

### 3.3 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ
- **è²¬ä»»åˆ†é›¢**: å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²ã‚’æ˜ç¢ºåŒ–
- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®é€£æºæ–¹æ³•
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ä¾‹å¤–å‡¦ç†ã®æ–¹é‡

### 3.4 ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
project/
â”œâ”€â”€ [main_file]      # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ [modules]        # æ©Ÿèƒ½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”œâ”€â”€ [config]         # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (å¿…è¦æ™‚)
â”œâ”€â”€ [data]           # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« (å¿…è¦æ™‚)
â”œâ”€â”€ [tests]          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« (å¿…è¦æ™‚)
â”œâ”€â”€ [docs]           # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (å¿…è¦æ™‚)
â””â”€â”€ README          # ä½¿ç”¨æ–¹æ³•èª¬æ˜
```

## 4. å®Ÿè£…æŒ‡é‡

### 4.1 ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„
- å„è¨€èªã®æ¨™æº–çš„ãªè¦ç´„ã«æº–æ‹ 
- ä¸€è²«æ€§ã®ã‚ã‚‹ãƒãƒ¼ãƒŸãƒ³ã‚°
- é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- å‹å®‰å…¨æ€§ã®ç¢ºä¿ï¼ˆå¯èƒ½ãªè¨€èªã§ï¼‰

### 4.2 å“è³ªè¦ä»¶
- å˜ä½“ãƒ†ã‚¹ãƒˆå¯¾å¿œå¯èƒ½ãªæ§‹é€ 
- ä¿å®ˆæ€§ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ
- æ‹¡å¼µæ€§ã®ã‚ã‚‹å®Ÿè£…
- é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 4.3 å®Ÿè£…å„ªå…ˆé †ä½
1. **ã‚³ã‚¢æ©Ÿèƒ½**: æœ€å°é™ã®å‹•ä½œã™ã‚‹å®Ÿè£…
2. **å…¥åŠ›æ¤œè¨¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®æ¤œè¨¼ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚º
3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªä¾‹å¤–å‡¦ç†
4. **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: ä½¿ã„ã‚„ã™ã•ã®å‘ä¸Š
5. **æ‹¡å¼µæ©Ÿèƒ½**: ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®å®Ÿè£…

### 4.4 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®
- å¿…è¦ã«å¿œã˜ã¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æœ€é©åŒ–
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–
- I/Oå‡¦ç†ã®åŠ¹ç‡åŒ–

## 5. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®å¼•ãç¶™ã

### 5.1 Copilotã¸ã®å®Ÿè£…æŒ‡ç¤º
- å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®æŒ‡ç¤º
- å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã¨å®Ÿè£…å†…å®¹
- ä½¿ç”¨ã™ã¹ãæŠ€è¡“ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹ãƒ»åˆ¶ç´„

### 5.2 æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆã®è¦³ç‚¹
- å‹•ä½œç¢ºèªæ–¹æ³•
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¾‹
- ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®å‡¦ç†

### 5.3 å®Ÿè¡Œãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•
- å®Ÿè¡Œç’°å¢ƒã®æº–å‚™
- ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ãƒ»æ‰‹é †

"""
        
        return design_doc.strip()


if __name__ == "__main__":
    """
    DesignPhase å˜ä½“å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
    """
    print("ğŸ”¬ DesignPhase å˜ä½“å®Ÿè¡Œãƒ†ã‚¹ãƒˆ")
    print("=" * 50)
    
    # ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    test_request = input("ğŸ’­ ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Enterã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ): ").strip()
    if not test_request:
        test_request = "Pythonã§ç°¡å˜ãªToDoãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„"
    
    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    from .context import ProjectContext
    context = ProjectContext(user_request=test_request)
    
    # æ¨¡æ“¬è¦ä»¶åˆ†æçµæœã‚’è¨­å®šï¼ˆè¨€èªéä¾å­˜ï¼‰
    mock_requirement = {
        "raw_response": f"""
## æ©Ÿèƒ½è¦ä»¶åˆ†æ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: {test_request}
- **ã‚³ã‚¢æ©Ÿèƒ½**: è¦ä»¶ã«å¿œã˜ãŸåŸºæœ¬æ©Ÿèƒ½
- **UI/UXè¦ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã‚’é‡è¦–ã—ãŸè¨­è¨ˆ
- **ãƒ‡ãƒ¼ã‚¿å‡¦ç†**: å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»æ“ä½œæ©Ÿèƒ½

## éæ©Ÿèƒ½è¦ä»¶
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å¿œç­”é€Ÿåº¦ãƒ»å‡¦ç†åŠ¹ç‡ã®æœ€é©åŒ–
- **æ‹¡å¼µæ€§**: å°†æ¥çš„ãªæ©Ÿèƒ½è¿½åŠ ã¸ã®å¯¾å¿œ
- **ä¿å®ˆæ€§**: èª­ã¿ã‚„ã™ãå¤‰æ›´ã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰æ§‹é€ 
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: é©åˆ‡ãªå…¥åŠ›æ¤œè¨¼ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## æŠ€è¡“èª¿æŸ»çµæœ
- **æ¨å¥¨æŠ€è¡“**: è¦ä»¶ã«æœ€é©ãªè¨€èªãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’é¸æŠ
- **é–‹ç™ºç’°å¢ƒ**: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
- **ä¾å­˜é–¢ä¿‚**: å¿…è¦æœ€å°é™ã®å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨
- **å®Ÿè¡Œç’°å¢ƒ**: ä¸€èˆ¬çš„ãªç’°å¢ƒã§ã®å‹•ä½œä¿è¨¼
""",
        "analysis_completed": True,
        "user_request": test_request
    }
    
    context.add_phase_result("requirement", mock_requirement)
    
    # ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œ
    phase = DesignPhase()
    
    print(f"\nğŸš€ å®Ÿè¡Œé–‹å§‹: {test_request}")
    print("ğŸ“‹ æ¨¡æ“¬è¦ä»¶åˆ†æçµæœã‚’ä½¿ç”¨")
    print("-" * 50)
    
    result = phase.execute_sync(context)
    
    print("-" * 50)
    print("âœ… å®Ÿè¡Œå®Œäº†!")
    print(f"ğŸ¯ è¨­è¨ˆæˆåŠŸ: {result.get('design_completed', False)}")
    
    if result.get('technical_specification'):
        print("\nğŸ“ æŠ€è¡“è¨­è¨ˆçµæœ:")
        spec = result['technical_specification']
        print(spec[:800] + "..." if len(spec) > 800 else spec)
    
    if result.get('error'):
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {result['error']}")